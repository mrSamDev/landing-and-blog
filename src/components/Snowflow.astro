---
// Snowfall.astro - Astro component
import type { SnowfallCanvasConfig } from '../utils/snow-fall/canvas';

interface Props extends Partial<SnowfallCanvasConfig> {
    /**
     * Any CSS classes to add to the canvas element.
     */
    class?: string;
    /**
     * Inline styles for the canvas element.
     */
    style?: string;
}

const {
    color = '#dee4fd',
    changeFrequency = 200,
    radius = [0.5, 3.0],
    speed = [1.0, 3.0],
    wind = [-0.5, 2.0],
    rotationSpeed = [-1.0, 1.0],
    opacity = [1, 1],
    snowflakeCount = 150,
    images,
    enable3DRotation = false,
    class: className = '',
    style = ''
} = Astro.props;
---

<canvas
    id="snowfall-canvas"
    class={`snowfall-canvas ${className}`}
    style={`position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; ${style}`}
    data-snowfall-config={JSON.stringify({
        color,
        changeFrequency,
        radius,
        speed,
        wind,
        rotationSpeed,
        opacity,
        snowflakeCount,
        images,
        enable3DRotation
    })}></canvas>

<script>
    import SnowfallCanvas from '../utils/snow-fall/canvas';

    let currentSnowfall: SnowfallCanvas | null = null;
    let resizeHandler: (() => void) | null = null;

    function isSnowfallSeason(): boolean {
        const now = new Date();
        const month = now.getMonth(); // 0-11 (0 = January, 11 = December)
        const day = now.getDate(); // 1-31

        // Show snowfall between December 1 and January 15
        // December is month 11, January is month 0
        if (month === 11) {
            // December - show from the 1st onwards
            return day >= 1;
        } else if (month === 0) {
            // January - show until the 15th
            return day <= 15;
        }

        return false;
    }

    function cleanupSnowfall(): void {
        if (currentSnowfall) {
            currentSnowfall.destroy();
            currentSnowfall = null;
        }
        if (resizeHandler) {
            window.removeEventListener('resize', resizeHandler);
            resizeHandler = null;
        }
    }

    function initSnowfall(): void {
        // Clean up any existing snowfall
        cleanupSnowfall();

        // Check if it's snowfall season
        if (!isSnowfallSeason()) {
            return;
        }

        const canvas = document.getElementById('snowfall-canvas') as HTMLCanvasElement | null;
        if (!canvas) return;

        // Set canvas to window size
        resizeHandler = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        };

        resizeHandler();
        window.addEventListener('resize', resizeHandler);

        // Get config from data attribute
        const configStr = canvas.getAttribute('data-snowfall-config');
        if (!configStr) return;

        const config = JSON.parse(configStr);

        currentSnowfall = new SnowfallCanvas(canvas, config);
    }

    // Initialize snowfall when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSnowfall);
    } else {
        initSnowfall();
    }

    // Reinitialize on Astro view transitions
    document.addEventListener('astro:page-load', initSnowfall);

    // Cleanup before page swap
    document.addEventListener('astro:before-swap', cleanupSnowfall);
</script>

<style>
    :global(html, body) {
        overflow-x: hidden;
    }

    .snowfall-canvas {
        z-index: 9999;
    }
</style>
